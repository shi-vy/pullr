<!DOCTYPE html>
<html>
<head>
  <title>üé¨ Pullr Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css?v={{ version }}">
</head>
<body>
  <h1>üé¨ Pullr Dashboard</h1>

  <form id="add-form" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
    <div style="flex-grow: 1;">
        <label for="magnet-input" style="display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9em;">Magnet Link</label>
        <input type="text" id="magnet-input" name="magnet" placeholder="magnet:?xt=urn:btih:..." required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white;" />
    </div>

    <div style="width: 120px;">
        <label for="tmdb-input" style="display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9em;">TMDB ID (Opt)</label>
        <input type="text" id="tmdb-input" name="tmdb_id" placeholder="e.g. 12345" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white;" />
    </div>

    <div style="width: 120px;">
        <label for="type-input" style="display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9em;">Media Type</label>
        <select id="type-input" name="media_type" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white;">
            <option value="movie">Movie</option>
            <option value="tv" selected>TV Show</option>
        </select>
    </div>

    <button type="submit" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; height: 35px;">Add</button>
  </form>

  <div style="margin: 16px 0; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px;">
    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
      <input type="checkbox" id="quickDownloadToggle" checked style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
      <div>
        <span style="font-weight: bold; color: #ff6680;">‚ö° Quick Download Mode</span>
        <p style="margin: 4px 0 0 0; color: #888; font-size: 0.9em;">
          Automatically download single-file torrents and torrents with only media files.
          Disable to manually confirm all downloads and set options.
        </p>
      </div>
    </label>
  </div>

  <h2>üì• Manual Downloads</h2>
  <table>
    <thead>
      <tr><th>Queue</th><th>ID</th><th>Status</th></tr>
    </thead>
    <tbody id="manualTorrentTable"></tbody>
  </table>

  <h2>üîÑ Auto-Detected Downloads</h2>
  <table>
    <thead>
      <tr><th>Queue</th><th>Name</th><th>Status</th></tr>
    </thead>
    <tbody id="externalTorrentTable"></tbody>
  </table>

  <div id="fileModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 id="modalTitle">Select Files</h2>
      <form id="fileForm">
        <div id="fileList"></div>
        <div id="folderNameSection" style="margin: 20px 0; display:none;">
          <label for="folderNameInput" style="display:block; margin-bottom:8px; color:#ccc;">
            Custom Folder Name <span style="color:#ff6680;">*</span> (required for multiple files):
          </label>
          <input type="text" id="folderNameInput" name="folder_name"
                 placeholder="e.g., 'Season 1' or 'Movie Collection'"
                 style="width:100%; padding:10px; background:#252525; color:#eee; border:1px solid #444; border-radius:6px;">
        </div>

        <div id="optionsSection" style="margin: 20px 0;">
          <button type="button" id="toggleOptionsBtn" class="gray" style="width:100%; text-align:left; padding:12px; font-size:0.95em;">
            ‚öôÔ∏è Options (click to expand)
          </button>
          <div id="optionsContent" style="display:none; margin-top:12px; padding:16px; background:#1f1f1f; border:1px solid #333; border-radius:6px;">
            <label for="stripPatternInput" style="display:block; margin-bottom:8px; color:#ccc;">
              Strip Pattern from Filenames:
            </label>
            <input type="text" id="stripPatternInput" name="strip_pattern"
                   placeholder="e.g., '[Judas]' or '[SubsPlease]'"
                   style="width:100%; padding:10px; background:#252525; color:#eee; border:1px solid #444; border-radius:6px; margin-bottom:8px;">
            <p style="color:#888; font-size:0.85em; margin:0;">
              This pattern will be removed from the start of each filename, along with any trailing spaces.
              Example: "[Judas] Video.mkv" becomes "Video.mkv"
            </p>
          </div>
        </div>

        <div class="button-row">
          <button type="button" id="selectAllBtn" class="blue">Select All</button>
          <button type="submit" id="downloadSelectedBtn" class="green">Download Selected</button>
          <button type="button" id="cancelBtn" class="gray">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  // --- Quick Download Mode State ---
  const quickDownloadToggle = document.getElementById('quickDownloadToggle');
  const savedQuickDownload = localStorage.getItem('quickDownloadMode');
  if (savedQuickDownload !== null) {
    quickDownloadToggle.checked = savedQuickDownload === 'true';
  }
  quickDownloadToggle.addEventListener('change', () => {
    localStorage.setItem('quickDownloadMode', quickDownloadToggle.checked);
  });

  // --- Handle Add Form ---
  const form = document.getElementById('add-form');
  const input = document.getElementById('magnet-input');
  const tmdbInput = document.getElementById('tmdb-input');
  const typeInput = document.getElementById('type-input');

  if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const magnet = input.value.trim();
        if (!magnet) return;

        const tmdbId = tmdbInput ? tmdbInput.value.trim() : '';
        const mediaType = typeInput ? typeInput.value : 'movie';

        try {
          const resp = await fetch('/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              magnet: magnet,
              quick_download: quickDownloadToggle.checked.toString(),
              tmdb_id: tmdbId,
              media_type: mediaType
            })
          });
          const data = await resp.json();
          console.log('Torrent added:', data);
        } catch (err) {
          console.error('Error adding torrent:', err);
        }

        // Clear inputs
        input.value = '';
        if (tmdbInput) tmdbInput.value = '';
      });
  }

  // --- WebSocket & Dashboard Logic ---
  const manualTableBody = document.getElementById('manualTorrentTable');
  const externalTableBody = document.getElementById('externalTorrentTable');
  const colorMap = {
      WAITING_FOR_SELECTION: "gold",
      DOWNLOADING_FROM_REALDEBRID: "lightgreen",
      AVAILABLE_FROM_REALDEBRID: "lightblue",
      WAITING_IN_QUEUE: "orange",
      TRANSFERRING_TO_MEDIA_SERVER: "violet",
      FINISHED: "lime",
      FAILED: "red",
      WAITING_FOR_METADATA: "magenta"
    };

  const ws = new WebSocket("ws://" + window.location.host + "/ws");

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const manualTorrents = data.manual || {};
    const externalTorrents = data.external || {};
    populateTable(manualTableBody, manualTorrents, false);
    populateTable(externalTableBody, externalTorrents, true);
  };

  function populateTable(tableBody, torrents, isExternal) {
    tableBody.innerHTML = "";
    const sortedEntries = Object.entries(torrents).sort((a, b) => {
      const [idA, infoA] = a;
      const [idB, infoB] = b;
      if (infoA.is_active && !infoB.is_active) return -1;
      if (!infoA.is_active && infoB.is_active) return 1;
      return (infoA.queue_position || 999999) - (infoB.queue_position || 999999);
    });

    for (const [id, info] of sortedEntries) {
      const row = document.createElement("tr");
      const stateName = info.state.replace("TorrentState.", "");

      let queueDisplay = info.is_active ? "‚ñ∂Ô∏è Active" : (info.queue_position ? `#${info.queue_position}` : "‚Äî");

      let displayName = isExternal ? info.name : id;
      if (info.selected_files && info.selected_files.length > 0) {
        displayName = info.selected_files.join('<br>');
      }

      const progressDisplay = stateName === "DOWNLOADING_FROM_REALDEBRID" && info.progress > 0
          ? ` (${info.progress.toFixed(1)}%)` : "";

      let stateHTML = `<span style="color:${colorMap[stateName] || "white"}">${stateName}${progressDisplay}</span>`;

      if (info.tmdb_id) {
          stateHTML += `<br><span style="color:#4caf50; font-size:0.8em; border:1px solid #4caf50; border-radius:4px; padding:1px 4px; margin-top:2px; display:inline-block;">TAGGED: ${info.tmdb_id}</span>`;
      }
      if (info.error_message) {
        stateHTML += `<br><span style="color:red; font-size:0.9em;">‚ö†Ô∏è ${info.error_message}</span>`;
      }

      // Buttons
      // 1. Select Files Button (Manual only, when waiting)
      if (!isExternal && stateName === "WAITING_FOR_SELECTION" && info.files && info.files.length > 0) {
        stateHTML += `<div style="margin-top:4px;"><button onclick="openFileModal('${id}', ${JSON.stringify(info.files).replace(/"/g, "&quot;")})">Select Files</button></div>`;
      }

      // 2. Metadata Button (All torrents)
      // FIX: Enabled for manual torrents so you can fix WAITING_FOR_METADATA state
      if (stateName !== "FINISHED" && stateName !== "FAILED") {
         stateHTML += `<div style="margin-top:4px;"><button onclick="addMetadata('${id}')" style="font-size:0.8em;">${info.tmdb_id ? '‚úèÔ∏è Edit TMDB' : '‚ûï Add TMDB'}</button></div>`;
      }

      row.innerHTML = `<td>${queueDisplay}</td><td>${displayName}</td><td>${stateHTML}</td>`;
      tableBody.appendChild(row);
    }

    if (sortedEntries.length === 0) {
      const row = document.createElement("tr");
      row.innerHTML = `<td colspan="3" style="text-align:center; color:#666; font-style:italic;">No torrents yet</td>`;
      tableBody.appendChild(row);
    }
  }

  // --- Add/Edit Metadata Function ---
  async function addMetadata(torrentId) {
      const tmdbId = prompt("Enter TMDB ID (e.g., 12345):");
      if (!tmdbId) return;

      let mediaType = prompt("Enter Media Type (movie or tv):", "movie");
      if (!mediaType) return;
      mediaType = mediaType.toLowerCase().trim();

      try {
          const resp = await fetch(`/set_metadata/${torrentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({ tmdb_id: tmdbId, media_type: mediaType })
          });
          const data = await resp.json();
          if(data.status === 'ok') console.log("Metadata updated");
          else alert("Failed: " + data.message);
      } catch (e) {
          console.error(e);
          alert("Error updating metadata");
      }
  }

  ws.onclose = () => {
    console.log("WebSocket closed. Reconnecting...");
    setTimeout(() => location.reload(), 2000);
  };

  // --- File Selection Modal Logic ---
  const modal = document.getElementById("fileModal");
  const modalTitle = document.getElementById("modalTitle");
  const fileList = document.getElementById("fileList");
  const fileForm = document.getElementById("fileForm");
  const folderNameInput = document.getElementById("folderNameInput");
  const folderNameSection = document.getElementById("folderNameSection");
  const stripPatternInput = document.getElementById("stripPatternInput");
  const toggleOptionsBtn = document.getElementById("toggleOptionsBtn");
  const optionsContent = document.getElementById("optionsContent");
  const downloadSelectedBtn = document.getElementById("downloadSelectedBtn");
  let currentTorrentId = null;
  let totalFiles = 0;

  toggleOptionsBtn.addEventListener("click", () => {
    const isHidden = optionsContent.style.display === "none";
    optionsContent.style.display = isHidden ? "block" : "none";
    toggleOptionsBtn.textContent = isHidden ? "‚öôÔ∏è Options (click to collapse)" : "‚öôÔ∏è Options (click to expand)";
  });

  function openFileModal(torrentId, files) {
    currentTorrentId = torrentId;
    totalFiles = files.length;
    modalTitle.textContent = `Select Files for ${torrentId}`;

    fileList.innerHTML = files.map((f) => `
      <div class="file-row">
        <input type="checkbox" name="file" value="${f.id}" id="cb_${f.id}" class="file-checkbox">
        <label for="cb_${f.id}" class="file-details">
          <span class="filename">${f.name}</span>
          <span class="filesize">${(f.bytes / 1e6).toFixed(1)} MB</span>
        </label>
      </div>
    `).join("");

    folderNameInput.value = "";
    stripPatternInput.value = "";
    optionsContent.style.display = "none";
    toggleOptionsBtn.textContent = "‚öôÔ∏è Options (click to expand)";

    if (totalFiles > 1) {
      folderNameSection.style.display = "block";
    } else {
      folderNameSection.style.display = "none";
    }

    document.querySelectorAll(".file-checkbox").forEach(cb => {
      cb.addEventListener("change", updateButtonStates);
    });
    folderNameInput.addEventListener("input", updateButtonStates);

    modal.style.display = "block";
    updateButtonStates();
  }

  function updateButtonStates() {
    const selectedCount = document.querySelectorAll("#fileList input:checked").length;
    const folderName = folderNameInput.value.trim();
    if (selectedCount > 1) {
      const isValid = folderName.length > 0;
      downloadSelectedBtn.disabled = !isValid;
      downloadSelectedBtn.style.opacity = isValid ? "1" : "0.5";
      downloadSelectedBtn.style.cursor = isValid ? "pointer" : "not-allowed";
    } else {
      downloadSelectedBtn.disabled = selectedCount === 0;
      downloadSelectedBtn.style.opacity = selectedCount > 0 ? "1" : "0.5";
      downloadSelectedBtn.style.cursor = selectedCount > 0 ? "pointer" : "not-allowed";
    }
  }

  document.getElementById("selectAllBtn").onclick = () => {
    document.querySelectorAll(".file-checkbox").forEach(cb => cb.checked = true);
    updateButtonStates();
    if (totalFiles > 1) folderNameInput.focus();
  };

  document.getElementById("cancelBtn").onclick = () => {
    modal.style.display = "none";
    currentTorrentId = null;
  };

  fileForm.onsubmit = (e) => {
    e.preventDefault();
    const selected = Array.from(document.querySelectorAll("#fileList input:checked")).map(cb => cb.value).join(",");
    if (!selected) return alert("Please select at least one file!");

    const folderName = folderNameInput.value.trim();
    const stripPattern = stripPatternInput.value.trim();

    if (document.querySelectorAll("#fileList input:checked").length > 1 && !folderName) {
      return alert("Please provide a custom folder name for multiple files!");
    }

    const params = new URLSearchParams({ files: selected });
    if (folderName) params.append("folder_name", folderName);
    if (stripPattern) params.append("strip_pattern", stripPattern);

    fetch(`/select_files/${currentTorrentId}`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params
    }).then(() => {
        modal.style.display = "none";
        currentTorrentId = null;
    }).catch(err => alert("File selection failed: " + err));
  };

  async function showVersion() {
    try {
      const resp = await fetch('/version');
      const data = await resp.json();
      document.getElementById('version-footer').textContent = `Pullr ‚Äì ${data.branch} @ ${data.commit}`;
    } catch (e) {}
  }
  showVersion();
  </script>

  <footer id="version-footer" style="text-align:center; margin-top:1em; color:#666; font-size:0.9em;">
    Loading version info...
  </footer>
</body>
</html>