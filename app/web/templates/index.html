<!DOCTYPE html>
<html>
<head>
  <title>üé¨ Pullr Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script>
    // Config injected from server
    const JELLYFIN_MODE = {{ "true" if jellyfin_mode else "false" }};
  </script>
</head>
<body>
  <h1>üé¨ Pullr Dashboard {% if jellyfin_mode %}<span style="font-size:0.5em; color:#28a745;">(Jellyfin Mode)</span>{% endif %}</h1>

  <form id="add-form">
    <div style="display:flex; gap:10px;">
        <input type="text" id="magnet-input" name="magnet" placeholder="Enter magnet link" required style="flex:2;" />
        {% if jellyfin_mode %}
        <select id="add-type-input" style="padding:0.5rem; border-radius:6px; background:#252525; color:#eee; border:1px solid #444;">
            <option value="tv">TV Show</option>
            <option value="movie">Movie</option>
        </select>
        <input type="text" id="add-tmdb-input" placeholder="TMDB ID (Optional)" style="flex:1;" />
        {% endif %}
        <button type="submit">Add</button>
    </div>
  </form>

  <div style="margin: 16px 0; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px;">
    <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
      <input type="checkbox" id="quickDownloadToggle" checked style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
      <div>
        <span style="font-weight: bold; color: #ff6680;">‚ö° Quick Download Mode</span>
        <p style="margin: 4px 0 0 0; color: #888; font-size: 0.9em;">
          {% if jellyfin_mode %}
          Auto-downloads if metadata is cached or provided. Otherwise pauses for input.
          {% else %}
          Automatically download single-file torrents and torrents with only media files.
          {% endif %}
        </p>
      </div>
    </label>
  </div>

  <h2>üì• Manual Downloads</h2>
  <table>
    <thead><tr><th>Queue</th><th>Name</th><th>Status</th></tr></thead>
    <tbody id="manualTorrentTable"></tbody>
  </table>

  <h2>üîÑ Auto-Detected Downloads</h2>
  <table>
    <thead><tr><th>Queue</th><th>Name</th><th>Status</th></tr></thead>
    <tbody id="externalTorrentTable"></tbody>
  </table>

  <div id="fileModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 id="modalTitle">Configure Download</h2>
      <form id="fileForm">

        <div id="metadataSection" style="margin-bottom: 20px; padding: 15px; background: #252525; border-radius: 6px; border-left: 4px solid #007bff; display:none;">
            <h3 style="margin-top:0; color:#007bff;">Jellyfin Metadata</h3>
            <p style="color:#aaa; font-size:0.9em; margin-bottom:10px;">Required: TMDB ID for folder naming.</p>

            <label style="display:block; margin-bottom:5px;">Type:</label>
            <select id="mediaTypeInput" style="width:100%; padding:8px; margin-bottom:10px; background:#333; color:white; border:1px solid #555; border-radius:4px;">
                <option value="tv">TV Show</option>
                <option value="movie">Movie</option>
            </select>

            <label style="display:block; margin-bottom:5px;">TMDB ID:</label>
            <input type="text" id="tmdbIdInput" placeholder="e.g. 1399 (for Game of Thrones)"
                   style="width:100%; box-sizing:border-box; background:#333; color:white;">
            <p style="color:#666; font-size:0.8em; margin-top:4px;">
                Find IDs at <a href="https://www.themoviedb.org/" target="_blank" style="color:#007bff;">themoviedb.org</a>
            </p>
        </div>

        <div id="fileList"></div>

        <div id="folderNameSection" style="margin: 20px 0; display:none;">
          <label for="folderNameInput" style="display:block; margin-bottom:8px; color:#ccc;">
            Custom Folder Name <span style="color:#ff6680;">*</span>:
          </label>
          <input type="text" id="folderNameInput" name="folder_name"
                 style="width:100%; padding:10px; background:#252525; color:#eee; border:1px solid #444; border-radius:6px;">
        </div>

        <div id="optionsSection" style="margin: 20px 0;">
          <button type="button" id="toggleOptionsBtn" class="gray" style="width:100%; text-align:left;">‚öôÔ∏è Options</button>
          <div id="optionsContent" style="display:none; margin-top:12px; padding:16px; background:#1f1f1f; border:1px solid #333; border-radius:6px;">
            <label>Strip Pattern from Filenames:</label>
            <input type="text" id="stripPatternInput" name="strip_pattern" placeholder="e.g., '[Judas]'"
                   style="width:100%; padding:10px; background:#252525; color:#eee; border:1px solid #444; border-radius:6px;">
          </div>
        </div>

        <div class="button-row">
          <button type="button" id="selectAllBtn" class="blue">Select All</button>
          <button type="submit" id="downloadSelectedBtn" class="green">Download Selected</button>
          <button type="button" id="cancelBtn" class="gray">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  // ... [Keep existing localStorage logic for quickDownloadToggle] ...
  const quickDownloadToggle = document.getElementById('quickDownloadToggle');
  const savedQuickDownload = localStorage.getItem('quickDownloadMode');
  if (savedQuickDownload !== null) quickDownloadToggle.checked = savedQuickDownload === 'true';
  quickDownloadToggle.addEventListener('change', () => localStorage.setItem('quickDownloadMode', quickDownloadToggle.checked));

  const form = document.getElementById('add-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const magnet = document.getElementById('magnet-input').value.trim();
    if (!magnet) return;

    const payload = new URLSearchParams({
      magnet: magnet,
      quick_download: quickDownloadToggle.checked.toString()
    });

    if (JELLYFIN_MODE) {
        payload.append("tmdb_id", document.getElementById('add-tmdb-input').value.trim());
        payload.append("media_type", document.getElementById('add-type-input').value);
    }

    try {
      await fetch('/add', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: payload });
    } catch (err) { console.error(err); }

    document.getElementById('magnet-input').value = '';
    if (JELLYFIN_MODE) document.getElementById('add-tmdb-input').value = '';
  });

  const ws = new WebSocket("ws://" + window.location.host + "/ws");
  const manualTableBody = document.getElementById('manualTorrentTable');
  const externalTableBody = document.getElementById('externalTorrentTable');

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    populateTable(manualTableBody, data.manual || {}, false);
    populateTable(externalTableBody, data.external || {}, true);
  };

  function populateTable(tableBody, torrents, isExternal) {
    tableBody.innerHTML = "";
    const sortedEntries = Object.entries(torrents).sort((a, b) => {
      // [Keep existing sort logic]
      if (a[1].is_active && !b[1].is_active) return -1;
      if (!a[1].is_active && b[1].is_active) return 1;
      return (a[1].queue_position || 999) - (b[1].queue_position || 999);
    });

    for (const [id, info] of sortedEntries) {
      const row = document.createElement("tr");
      let stateName = info.state.replace("TorrentState.", "");

      // Special logic for Jellyfin Metadata Wait
      if (JELLYFIN_MODE && info.needs_metadata) {
         stateName = "‚ö†Ô∏è NEEDS METADATA";
      }

      let queueDisplay = info.is_active ? "‚ñ∂Ô∏è Active" : (info.queue_position ? `#${info.queue_position}` : "‚Äî");
      let displayName = isExternal ? info.name : id;
      if (info.selected_files?.length > 0) displayName = info.selected_files.join('<br>');

      // Add TMDB info to display name if available
      if (info.canonical_title) {
          displayName = `<b>${info.canonical_title}</b><br><span style='font-size:0.8em; color:#888;'>TMDB: ${info.tmdb_id}</span>`;
      }

      let stateHTML = `<span style="color:white">${stateName}</span>`;
      if (info.error_message) stateHTML += `<br><span style="color:red; font-size:0.8em;">‚ö†Ô∏è ${info.error_message}</span>`;
      if (stateName === "DOWNLOADING_FROM_REALDEBRID" && info.progress > 0) stateHTML += ` (${info.progress}%)`;

      // Show "Configure" button if waiting for selection OR metadata
      if (!isExternal && (stateName === "WAITING_FOR_SELECTION" || stateName === "‚ö†Ô∏è NEEDS METADATA")) {
        const btnText = (JELLYFIN_MODE && info.needs_metadata) ? "Provide Metadata" : "Select Files";
        // Pass empty files array if files aren't ready/loaded yet but metadata is needed
        const filesData = info.files || [];
        stateHTML += `<br><button class="blue" style="margin-top:4px; font-size:0.8em; padding:4px 8px;"
            onclick='openFileModal("${id}", ${JSON.stringify(filesData).replace(/'/g, "&apos;")}, "${info.tmdb_id || ""}", "${info.media_type || "tv"}")'>
            ${btnText}
        </button>`;
      }

      row.innerHTML = `<td>${queueDisplay}</td><td>${displayName}</td><td>${stateHTML}</td>`;
      tableBody.appendChild(row);
    }
  }

  // Modal Logic
  const modal = document.getElementById("fileModal");
  const tmdbIdInput = document.getElementById("tmdbIdInput");
  const mediaTypeInput = document.getElementById("mediaTypeInput");
  let currentTorrentId = null;

  function openFileModal(torrentId, files, currentTmdbId, currentType) {
    currentTorrentId = torrentId;
    document.getElementById("modalTitle").textContent = `Configure ${torrentId}`;

    // Toggle Metadata Section
    const metadataSection = document.getElementById("metadataSection");
    const folderNameSection = document.getElementById("folderNameSection");

    if (JELLYFIN_MODE) {
        metadataSection.style.display = "block";
        folderNameSection.style.display = "none"; // Hide custom folder in Jellyfin mode
        tmdbIdInput.value = currentTmdbId || "";
        mediaTypeInput.value = currentType || "tv";
    } else {
        metadataSection.style.display = "none";
        folderNameSection.style.display = files.length > 1 ? "block" : "none";
    }

    const fileList = document.getElementById("fileList");
    if (files.length > 0) {
        fileList.innerHTML = files.map(f => `
          <div class="file-row">
            <input type="checkbox" name="file" value="${f.id}" id="cb_${f.id}" class="file-checkbox">
            <label for="cb_${f.id}" class="file-details">
              <span class="filename">${f.name}</span>
              <span class="filesize">${(f.bytes / 1e6).toFixed(1)} MB</span>
            </label>
          </div>
        `).join("");
    } else {
        fileList.innerHTML = "<p style='color:#888; text-align:center;'>Files not loaded yet or not available.</p>";
    }

    document.getElementById("optionsContent").style.display = "none";
    modal.style.display = "block";
    updateButtonStates();

    // Listeners
    document.querySelectorAll(".file-checkbox").forEach(cb => cb.addEventListener("change", updateButtonStates));
    tmdbIdInput.addEventListener("input", updateButtonStates);
  }

  function updateButtonStates() {
    const selectedCount = document.querySelectorAll("#fileList input:checked").length;
    const btn = document.getElementById("downloadSelectedBtn");

    let isValid = true;
    if (JELLYFIN_MODE) {
        // In Jellyfin mode, TMDB ID is mandatory
        if (!tmdbIdInput.value.trim()) isValid = false;
        // Also need at least one file selected if files are shown
        if (document.querySelectorAll(".file-checkbox").length > 0 && selectedCount === 0) isValid = false;
    } else {
        if (selectedCount === 0) isValid = false;
    }

    btn.disabled = !isValid;
    btn.style.opacity = isValid ? "1" : "0.5";
  }

  document.getElementById("selectAllBtn").onclick = () => {
      document.querySelectorAll(".file-checkbox").forEach(cb => cb.checked = true);
      updateButtonStates();
  };

  document.getElementById("cancelBtn").onclick = () => modal.style.display = "none";

  document.getElementById("fileForm").onsubmit = (e) => {
    e.preventDefault();

    // Gather files
    let selected = Array.from(document.querySelectorAll("#fileList input:checked")).map(cb => cb.value).join(",");
    // If no files listed (e.g. metadata only phase), we might handle differently,
    // but usually 'select_files' endpoint requires 'files'.
    // If we are just updating metadata, we might need to select all by default if files are missing?
    // For now assume user selects files.
    if (!selected && document.querySelectorAll(".file-checkbox").length > 0) return;

    if (!selected) selected = "all"; // Fallback if list is empty (auto-select all for metadata update)

    const params = new URLSearchParams({ files: selected });

    if (JELLYFIN_MODE) {
        params.append("tmdb_id", tmdbIdInput.value.trim());
        params.append("media_type", mediaTypeInput.value);
    } else {
        const folder = document.getElementById("folderNameInput").value.trim();
        if (folder) params.append("folder_name", folder);
    }

    const strip = document.getElementById("stripPatternInput").value.trim();
    if (strip) params.append("strip_pattern", strip);

    fetch(`/select_files/${currentTorrentId}`, {
        method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: params
    })
    .then(r => r.json())
    .then(data => {
        if(data.status === "error") alert(data.error);
        else modal.style.display = "none";
    });
  };
  </script>

  <footer id="version-footer" style="text-align:center; margin-top:1em; color:#666; font-size:0.9em;">
    Loading version info...
  </footer>

  <script>
  async function showVersion() {
    try {
      const resp = await fetch('/version');
      const data = await resp.json();
      const footer = document.getElementById('version-footer');
      footer.textContent = `Pullr ‚Äì ${data.branch} @ ${data.commit}`;
    } catch (e) {
      console.error("Failed to fetch version info:", e);
    }
  }
  showVersion();
  </script>

</body>
</html>